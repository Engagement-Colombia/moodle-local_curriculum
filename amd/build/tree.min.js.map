{"version":3,"file":"tree.min.js","sources":["../src/tree.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for managing curriculum tree interactions with lazy-loading via AJAX.\n *\n * @module     local_curriculum/tree\n * @copyright  2026 David Herney @ BambuCo\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str'], function($, Ajax, Templates, Notification, Str) {\n    'use strict';\n\n    const SELECTOR_TOGGLE = '.curriculum-tree-toggle';\n    const SELECTOR_CHILDREN = '.curriculum-tree-children';\n    const SELECTOR_NODE = '.curriculum-tree-node';\n    const SELECTOR_EXPAND_ALL = '.curriculum-tree-expand-all';\n    const SELECTOR_COLLAPSE_ALL = '.curriculum-tree-collapse-all';\n    const CLASS_COLLAPSED = 'curriculum-tree-collapsed';\n\n    /**\n     * Map of node types to their AJAX configuration.\n     */\n    var NODE_CONFIG = {\n        'program': {\n            ws: 'local_curriculum_get_versions',\n            template: 'local_curriculum/tree_versions',\n            param: 'programid'\n        },\n        'version': {\n            ws: 'local_curriculum_get_cycles',\n            template: 'local_curriculum/tree_cycles',\n            param: 'versionid'\n        },\n        'cycle': {\n            ws: 'local_curriculum_get_items',\n            template: 'local_curriculum/tree_items',\n            param: 'cycleid'\n        }\n    };\n\n    /**\n     * Ordered list of expandable node types for \"Expand All\".\n     */\n    var EXPANDABLE_TYPES = ['program', 'version', 'cycle'];\n\n    return {\n        /**\n         * Pre-loaded strings for partial templates.\n         */\n        strings: {},\n\n        /**\n         * Whether strings have been loaded.\n         */\n        stringsLoaded: null,\n\n        /**\n         * Initializes tree interactions.\n         */\n        init: function() {\n            this.loadStrings();\n            this.attachEventHandlers();\n        },\n\n        /**\n         * Pre-loads all strings needed by partial templates.\n         */\n        loadStrings: function() {\n            var self = this;\n            this.stringsLoaded = Str.get_strings([\n                {key: 'expandall', component: 'local_curriculum'},\n                {key: 'configure', component: 'local_curriculum'},\n                {key: 'noversions', component: 'local_curriculum'},\n                {key: 'nocycles', component: 'local_curriculum'},\n                {key: 'noitems', component: 'local_curriculum'},\n                {key: 'stage', component: 'local_curriculum'},\n                {key: 'durationdays', component: 'local_curriculum'},\n                {key: 'validitydays', component: 'local_curriculum'},\n                {key: 'loading', component: 'local_curriculum'},\n            ]).then(function(strings) {\n                self.strings = {\n                    expandlabel: strings[0],\n                    configurelabel: strings[1],\n                    noversionslabel: strings[2],\n                    nocycleslabel: strings[3],\n                    noitemslabel: strings[4],\n                    stagelabel: strings[5],\n                    durationlabel: strings[6],\n                    validitylabel: strings[7],\n                    loadinglabel: strings[8],\n                };\n                return self.strings;\n            });\n        },\n\n        /**\n         * Attaches event handlers for tree interactions.\n         */\n        attachEventHandlers: function() {\n            $(document).on('click', SELECTOR_TOGGLE, this.handleToggleClick.bind(this));\n            $(document).on('click', SELECTOR_EXPAND_ALL, this.handleExpandAll.bind(this));\n            $(document).on('click', SELECTOR_COLLAPSE_ALL, this.handleCollapseAll.bind(this));\n        },\n\n        /**\n         * Handles toggle button clicks to expand/collapse nodes.\n         *\n         * @param {Object} e - Event object\n         */\n        handleToggleClick: function(e) {\n            e.preventDefault();\n            var $button = $(e.currentTarget);\n            var $node = $button.closest(SELECTOR_NODE);\n            var $children = $node.children(SELECTOR_CHILDREN);\n\n            if ($children.length === 0) {\n                return;\n            }\n\n            var isExpanded = $button.attr('aria-expanded') === 'true';\n\n            if (isExpanded) {\n                // Collapse.\n                this.collapseNode($button, $node, $children);\n            } else {\n                // Expand: load children if not loaded yet.\n                var loaded = $children.attr('data-loaded');\n                if (loaded === 'false') {\n                    this.loadChildren($node, $children);\n                } else {\n                    this.expandNode($button, $node, $children);\n                }\n            }\n        },\n\n        /**\n         * Expands a node visually.\n         *\n         * @param {jQuery} $button The toggle button.\n         * @param {jQuery} $node The tree node.\n         * @param {jQuery} $children The children container.\n         */\n        expandNode: function($button, $node, $children) {\n            $button.attr('aria-expanded', 'true');\n            $node.removeClass(CLASS_COLLAPSED);\n            $children.slideDown(200);\n        },\n\n        /**\n         * Collapses a node visually.\n         *\n         * @param {jQuery} $button The toggle button.\n         * @param {jQuery} $node The tree node.\n         * @param {jQuery} $children The children container.\n         */\n        collapseNode: function($button, $node, $children) {\n            $button.attr('aria-expanded', 'false');\n            $node.addClass(CLASS_COLLAPSED);\n            $children.slideUp(200);\n        },\n\n        /**\n         * Loads children via AJAX for a given node.\n         *\n         * @param {jQuery} $node The tree node.\n         * @param {jQuery} $container The children container.\n         * @return {Promise} A promise that resolves when children are loaded and rendered.\n         */\n        loadChildren: function($node, $container) {\n            var type = $node.data('node-type');\n            var id = $node.data('node-id');\n            var config = NODE_CONFIG[type];\n\n            if (!config) {\n                return $.Deferred().resolve().promise();\n            }\n\n            // Show loading indicator.\n            var self = this;\n            $container.html('<div class=\"curriculum-tree-loading p-2 text-muted\">' +\n                '<i class=\"fa fa-spinner fa-spin\"></i> ' + (self.strings.loadinglabel || '') + '</div>');\n            $container.show();\n            $node.removeClass(CLASS_COLLAPSED);\n            $node.find('> .curriculum-tree-item > ' + SELECTOR_TOGGLE).attr('aria-expanded', 'true');\n\n            var args = {};\n            args[config.param] = id;\n\n            // Wait for strings to be loaded, then fetch data.\n            return self.stringsLoaded\n                .then(function() {\n                    return Ajax.call([{methodname: config.ws, args: args}])[0];\n                })\n                .then(function(data) {\n                    var context = $.extend({items: data, manageurl: M.cfg.wwwroot}, self.strings);\n                    return Templates.render(config.template, context);\n                })\n                .then(function(html, js) {\n                    $container.html(html);\n                    $container.attr('data-loaded', 'true');\n                    Templates.runTemplateJS(js);\n\n                    // Ensure expanded state.\n                    var $button = $node.find('> .curriculum-tree-item > ' + SELECTOR_TOGGLE);\n                    self.expandNode($button, $node, $container);\n                    return true;\n                })\n                .catch(function(ex) {\n                    $container.html('<div class=\"alert alert-danger p-2\">Error loading data.</div>');\n                    Notification.exception(ex);\n                });\n        },\n\n        /**\n         * Loads all unloaded nodes of a specific type.\n         *\n         * @param {jQuery} $tree The tree root element.\n         * @param {string} nodeType The node type to expand (program, version, cycle).\n         * @return {Promise} A promise that resolves when all nodes of this type are loaded.\n         */\n        expandNodesByType: function($tree, nodeType) {\n            var self = this;\n            var promises = [];\n\n            $tree.find('[data-node-type=\"' + nodeType + '\"]').each(function() {\n                var $node = $(this);\n                var $children = $node.children(SELECTOR_CHILDREN);\n\n                if ($children.length === 0) {\n                    return;\n                }\n\n                var loaded = $children.attr('data-loaded');\n                if (loaded === 'false') {\n                    promises.push(self.loadChildren($node, $children));\n                } else {\n                    var $button = $node.find('> .curriculum-tree-item > ' + SELECTOR_TOGGLE);\n                    self.expandNode($button, $node, $children);\n                }\n            });\n\n            if (promises.length === 0) {\n                return $.Deferred().resolve().promise();\n            }\n\n            return $.when.apply($, promises);\n        },\n\n        /**\n         * Expands all nodes in the tree, loading children level by level.\n         *\n         * @param {Object} e - Event object\n         */\n        handleExpandAll: function(e) {\n            e.preventDefault();\n            var $btn = $(e.currentTarget);\n            var $tree = $btn.closest('.curriculum-tree');\n            var self = this;\n\n            // Disable button during loading.\n            $btn.prop('disabled', true);\n\n            // Expand level by level: programs → versions → cycles.\n            var chain = $.Deferred().resolve().promise();\n\n            $.each(EXPANDABLE_TYPES, function(index, type) {\n                chain = chain.then(function() {\n                    return self.expandNodesByType($tree, type);\n                });\n            });\n\n            chain.always(function() {\n                $btn.prop('disabled', false);\n            });\n        },\n\n        /**\n         * Collapses all nodes in the tree.\n         *\n         * @param {Object} e - Event object\n         */\n        handleCollapseAll: function(e) {\n            e.preventDefault();\n            var $tree = $(e.currentTarget).closest('.curriculum-tree');\n            var $toggles = $tree.find(SELECTOR_TOGGLE);\n            var self = this;\n\n            $toggles.each(function() {\n                var $toggle = $(this);\n                var $node = $toggle.closest(SELECTOR_NODE);\n                var $children = $node.children(SELECTOR_CHILDREN);\n\n                if ($children.length > 0) {\n                    self.collapseNode($toggle, $node, $children);\n                }\n            });\n        },\n    };\n});\n"],"names":["define","$","Ajax","Templates","Notification","Str","SELECTOR_TOGGLE","NODE_CONFIG","program","ws","template","param","version","cycle","EXPANDABLE_TYPES","strings","stringsLoaded","init","this","loadStrings","attachEventHandlers","self","get_strings","key","component","then","expandlabel","configurelabel","noversionslabel","nocycleslabel","noitemslabel","stagelabel","durationlabel","validitylabel","loadinglabel","document","on","handleToggleClick","bind","handleExpandAll","handleCollapseAll","e","preventDefault","$button","currentTarget","$node","closest","$children","children","length","attr","collapseNode","loadChildren","expandNode","removeClass","slideDown","addClass","slideUp","$container","type","data","id","config","Deferred","resolve","promise","html","show","find","args","call","methodname","context","extend","items","manageurl","M","cfg","wwwroot","render","js","runTemplateJS","catch","ex","exception","expandNodesByType","$tree","nodeType","promises","each","push","when","apply","$btn","prop","chain","index","always","$toggles","$toggle"],"mappings":"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"}