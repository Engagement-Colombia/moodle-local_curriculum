/**
 * Module for managing curriculum tree interactions with lazy-loading via AJAX.
 *
 * @module     local_curriculum/tree
 * @copyright  2026 David Herney @ BambuCo
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/templates","core/notification","core/str"],function(e,r,l,t,a){"use strict";const n=".curriculum-tree-toggle",c=".curriculum-tree-children",i=".curriculum-tree-node",o="curriculum-tree-collapsed";var u={program:{ws:"local_curriculum_get_versions",template:"local_curriculum/tree_versions",param:"programid"},version:{ws:"local_curriculum_get_cycles",template:"local_curriculum/tree_cycles",param:"versionid"},cycle:{ws:"local_curriculum_get_items",template:"local_curriculum/tree_items",param:"cycleid"}},s=["program","version","cycle"];return{strings:{},stringsLoaded:null,init:function(){this.loadStrings(),this.attachEventHandlers()},loadStrings:function(){var e=this;this.stringsLoaded=a.get_strings([{key:"expandall",component:"local_curriculum"},{key:"configure",component:"local_curriculum"},{key:"noversions",component:"local_curriculum"},{key:"nocycles",component:"local_curriculum"},{key:"noitems",component:"local_curriculum"},{key:"stage",component:"local_curriculum"},{key:"durationdays",component:"local_curriculum"},{key:"validitydays",component:"local_curriculum"},{key:"loading",component:"local_curriculum"}]).then(function(r){return e.strings={expandlabel:r[0],configurelabel:r[1],noversionslabel:r[2],nocycleslabel:r[3],noitemslabel:r[4],stagelabel:r[5],durationlabel:r[6],validitylabel:r[7],loadinglabel:r[8]},e.strings})},attachEventHandlers:function(){e(document).on("click",n,this.handleToggleClick.bind(this)),e(document).on("click",".curriculum-tree-expand-all",this.handleExpandAll.bind(this)),e(document).on("click",".curriculum-tree-collapse-all",this.handleCollapseAll.bind(this))},handleToggleClick:function(r){r.preventDefault();var l=e(r.currentTarget),t=l.closest(i),a=t.children(c);0!==a.length&&("true"===l.attr("aria-expanded")?this.collapseNode(l,t,a):"false"===a.attr("data-loaded")?this.loadChildren(t,a):this.expandNode(l,t,a))},expandNode:function(e,r,l){e.attr("aria-expanded","true"),r.removeClass(o),l.slideDown(200)},collapseNode:function(e,r,l){e.attr("aria-expanded","false"),r.addClass(o),l.slideUp(200)},loadChildren:function(a,c){var i=a.data("node-type"),s=a.data("node-id"),d=u[i];if(!d)return e.Deferred().resolve().promise();var m=this;c.html('<div class="curriculum-tree-loading p-2 text-muted"><i class="fa fa-spinner fa-spin"></i> '+(m.strings.loadinglabel||"")+"</div>"),c.show(),a.removeClass(o),a.find("> .curriculum-tree-item > "+n).attr("aria-expanded","true");var p={};return p[d.param]=s,m.stringsLoaded.then(function(){return r.call([{methodname:d.ws,args:p}])[0]}).then(function(r){var t=e.extend({items:r,manageurl:M.cfg.wwwroot},m.strings);return l.render(d.template,t)}).then(function(e,r){c.html(e),c.attr("data-loaded","true"),l.runTemplateJS(r);var t=a.find("> .curriculum-tree-item > "+n);m.expandNode(t,a,c)}).catch(function(e){c.html('<div class="alert alert-danger p-2">Error loading data.</div>'),t.exception(e)})},expandNodesByType:function(r,l){var t=this,a=[];return r.find('[data-node-type="'+l+'"]').each(function(){var r=e(this),l=r.children(c);if(0!==l.length)if("false"===l.attr("data-loaded"))a.push(t.loadChildren(r,l));else{var i=r.find("> .curriculum-tree-item > "+n);t.expandNode(i,r,l)}}),0===a.length?e.Deferred().resolve().promise():e.when.apply(e,a)},handleExpandAll:function(r){r.preventDefault();var l=e(r.currentTarget),t=l.closest(".curriculum-tree"),a=this;l.prop("disabled",!0);var n=e.Deferred().resolve().promise();e.each(s,function(e,r){n=n.then(function(){return a.expandNodesByType(t,r)})}),n.always(function(){l.prop("disabled",!1)})},handleCollapseAll:function(r){r.preventDefault();var l=e(r.currentTarget).closest(".curriculum-tree").find(n),t=this;l.each(function(){var r=e(this),l=r.closest(i),a=l.children(c);a.length>0&&t.collapseNode(r,l,a)})}}});