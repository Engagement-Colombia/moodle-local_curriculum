/**
 * Module for managing curriculum tree interactions with lazy-loading via AJAX.
 *
 * @module     local_curriculum/tree
 * @copyright  2026 David Herney @ BambuCo
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_curriculum/tree",["jquery","core/ajax","core/templates","core/notification","core/str"],function($,Ajax,Templates,Notification,Str){const SELECTOR_TOGGLE=".curriculum-tree-toggle",SELECTOR_NODE=".curriculum-tree-node";var NODE_CONFIG={program:{ws:"local_curriculum_get_versions",template:"local_curriculum/tree_versions",param:"programid"},version:{ws:"local_curriculum_get_cycles",template:"local_curriculum/tree_cycles",param:"versionid"},cycle:{ws:"local_curriculum_get_items",template:"local_curriculum/tree_items",param:"cycleid"}},EXPANDABLE_TYPES=["program","version","cycle"];return{strings:{},stringsLoaded:null,filterTimer:null,init:function(){this.loadStrings(),this.attachEventHandlers()},loadStrings:function(){var self=this;this.stringsLoaded=Str.get_strings([{key:"expandall",component:"local_curriculum"},{key:"configure",component:"local_curriculum"},{key:"noversions",component:"local_curriculum"},{key:"nocycles",component:"local_curriculum"},{key:"noitems",component:"local_curriculum"},{key:"stage",component:"local_curriculum"},{key:"durationdays",component:"local_curriculum"},{key:"validitydays",component:"local_curriculum"},{key:"loading",component:"local_curriculum"}]).then(function(strings){return self.strings={expandlabel:strings[0],configurelabel:strings[1],noversionslabel:strings[2],nocycleslabel:strings[3],noitemslabel:strings[4],stagelabel:strings[5],durationlabel:strings[6],validitylabel:strings[7],loadinglabel:strings[8]},self.strings})},attachEventHandlers:function(){$(document).on("click",SELECTOR_TOGGLE,this.handleToggleClick.bind(this)),$(document).on("click",".curriculum-tree-expand-all",this.handleExpandAll.bind(this)),$(document).on("click",".curriculum-tree-collapse-all",this.handleCollapseAll.bind(this)),$(document).on("input",".curriculum-tree-filter",this.handleFilterInput.bind(this))},handleToggleClick:function(e){e.preventDefault();var $button=$(e.currentTarget),$node=$button.closest(SELECTOR_NODE),$children=$node.children(".curriculum-tree-children");0!==$children.length&&("true"===$button.attr("aria-expanded")?this.collapseNode($button,$node,$children):"false"===$children.attr("data-loaded")?this.loadChildren($node,$children):this.expandNode($button,$node,$children))},expandNode:function($button,$node,$children){$button.attr("aria-expanded","true"),$node.removeClass("curriculum-tree-collapsed"),$children.slideDown(200)},collapseNode:function($button,$node,$children){$button.attr("aria-expanded","false"),$node.addClass("curriculum-tree-collapsed"),$children.slideUp(200)},loadChildren:function($node,$container){var type=$node.data("node-type"),id=$node.data("node-id"),config=NODE_CONFIG[type];if(!config)return $.Deferred().resolve().promise();var self=this;$container.html('<div class="curriculum-tree-loading p-2 text-muted"><i class="fa fa-spinner fa-spin"></i> '+(self.strings.loadinglabel||"")+"</div>"),$container.show(),$node.removeClass("curriculum-tree-collapsed"),$node.find("> .curriculum-tree-item > "+SELECTOR_TOGGLE).attr("aria-expanded","true");var args={};return args[config.param]=id,self.stringsLoaded.then(function(){return Ajax.call([{methodname:config.ws,args:args}])[0]}).then(function(data){var context=$.extend({items:data,manageurl:M.cfg.wwwroot},self.strings);return Templates.render(config.template,context)}).then(function(html,js){$container.html(html),$container.attr("data-loaded","true"),Templates.runTemplateJS(js);var $button=$node.find("> .curriculum-tree-item > "+SELECTOR_TOGGLE);return self.expandNode($button,$node,$container),!0}).catch(function(ex){$container.html('<div class="alert alert-danger p-2">Error loading data.</div>'),Notification.exception(ex)})},expandNodesByType:function($tree,nodeType){var self=this,promises=[];return $tree.find('[data-node-type="'+nodeType+'"]').each(function(){var $node=$(this),$children=$node.children(".curriculum-tree-children");if(0!==$children.length)if("false"===$children.attr("data-loaded"))promises.push(self.loadChildren($node,$children));else{var $button=$node.find("> .curriculum-tree-item > "+SELECTOR_TOGGLE);self.expandNode($button,$node,$children)}}),0===promises.length?$.Deferred().resolve().promise():$.when.apply($,promises)},handleExpandAll:function(e){e.preventDefault();var $btn=$(e.currentTarget),$tree=$btn.closest(".curriculum-tree"),self=this;$btn.prop("disabled",!0);var chain=$.Deferred().resolve().promise();$.each(EXPANDABLE_TYPES,function(index,type){chain=chain.then(function(){return self.expandNodesByType($tree,type)})}),chain.always(function(){$btn.prop("disabled",!1)})},handleCollapseAll:function(e){e.preventDefault();var $toggles=$(e.currentTarget).closest(".curriculum-tree").find(SELECTOR_TOGGLE),self=this;$toggles.each(function(){var $toggle=$(this),$node=$toggle.closest(SELECTOR_NODE),$children=$node.children(".curriculum-tree-children");$children.length>0&&self.collapseNode($toggle,$node,$children)})},handleFilterInput:function(e){var self=this,$input=$(e.currentTarget),$tree=$input.closest(".curriculum-tree");clearTimeout(self.filterTimer),self.filterTimer=setTimeout(function(){self.applyFilter($tree,$input.val())},300)},applyFilter:function($tree,keyword){var self=this,term=$.trim(keyword).toLowerCase(),$allNodes=$tree.find(SELECTOR_NODE);if(""!==term){$allNodes.addClass("curriculum-tree-filtered-out");var nodes=$allNodes.get().reverse();$.each(nodes,function(index,el){var $node=$(el),selfMatch=-1!==$node.children(".curriculum-tree-item").find(".curriculum-tree-content").text().toLowerCase().indexOf(term),$children=$node.children(".curriculum-tree-children"),childMatch=!1;if($children.length>0&&(childMatch=$children.find("> "+SELECTOR_NODE+":not(.curriculum-tree-filtered-out)").length>0),(selfMatch||childMatch)&&($node.removeClass("curriculum-tree-filtered-out"),childMatch&&$children.length>0&&"none"===$children.css("display"))){var $button=$node.find("> .curriculum-tree-item > "+SELECTOR_TOGGLE);$button.length>0&&self.expandNode($button,$node,$children)}})}else $allNodes.removeClass("curriculum-tree-filtered-out")}}});

//# sourceMappingURL=tree.min.js.map